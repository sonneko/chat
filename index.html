<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>チャット用サイト</title>
    <style>
        .title {
            font-size: 30px;
            width: 100vw;
            background-color: aqua;
            text-align: center;
            font-family: Arial, Helvetica, sans-serif;
            position: fixed;
            position: absolute;
            top: 0;
        }

        .attention {
            color: red;
            text-align: center;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333333;
            background-color: #dddddd;
            font-size: 30px;
            width: 300px;
            height: 70px;
            border-radius: 3px;
            box-shadow: 2px 2px 6px 1px rgba(0, 0, 0, 0.45);
        }

        .btn:hover {
            box-shadow: inset 2px 2px 6px 1px rgba(0, 0, 0, 0.45);
        }

        .indexPage {
            text-align: center;
        }

        .chat {
            width: 90vw;
            height: 90vh;
            box-shadow: inset 2px 2px 6pz 1px rgba(0, 0, 0, 0.45);
        }

        .mess {
            padding: 0;
            width: 500px;
            margin-top: 100px;
            margin-bottom: 100px;
            border-radius: 50%;
        }
        .oppMessa .mess {
            background-color: aquamarine;
        }
        .myMessa .mess {
            background-color: #dddddd;
        }
        .time {
            color: rgba(0, 0, 0, 0.25);
            text-align: right;
        }
    </style>
</head>

<body>
    <div id="indexPage">
        <h1 class="title">ちゃっとようのさいと</h1>
        <p class="attention">知識ある人なら他の人のちゃっと内容が見れるっちゃ見れるのでご注意ください。</p>
        <a href="intro.html">このサイトについて→</a>
        <p>↓自分のユーサーIDを入力！</p>
        <input type="text" id="userId">
        <p>↓相手のユーザーIDを入力！</p>
        <input type="text" id="toId">
        <div class="btn" onclick="btnClicked()">ちゃっとを開始！！</div>
        <div id="formAttention"></div>
    </div>
    <div id="contentPage">
        <h1 class="title">ちゃっとようのさいと</h1>
        <p>ちゃっとぺーじです</p>
        <div id="chat">

        </div>
        <div id="form">

        </div>
    </div>
    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyqrKcM7nyESKmHp5Hodf99BwyihCogPugbQg8P09xBCAJnMM6c7kcCRhL5Fo3TfOrQ_A/exec"
        // 要素を取得
        const indexPageEle = document.getElementById("indexPage");
        const contentPageEle = document.getElementById("contentPage");
        const userIdEle = document.getElementById("userId");
        const toIdEle = document.getElementById("toId");
        const formAttentionEle = document.getElementById("formAttention");
        const chatEle = document.getElementById("chat");
        const formEle = document.getElementById("form");
        //現在のURLを取得
        const nowUrl = window.location.href;
        // ver を保持する変数
        let ver;
        // paramsを取得
        const params = nowUrl.split("?")[1].split("&");
        let paramsObj = {}
        params.forEach((item, index) => {
            const splitStr = item.split("=");
            paramsObj[splitStr[0]] = splitStr[1];
        })
        const render = (version) => {
            ver = version;
            if (version === "chat") {
                indexPageEle.style.display = "none";
                contentPageEle.style.display = "initial";
                loadChat();
            }
            if (version === "index") {
                indexPageEle.style.display = "initial";
                contentPageEle.style.display = "none";
            }
        }
        if (paramsObj.user === undefined) render("index");
        else if (paramsObj.to === undefined) render("index");
        else render("chat");
        function btnClicked() {
            user = userIdEle.value;
            to = toIdEle.value;
            if (user == "" || to == "") {
                formAttentionEle.innerText = "なんか書いてないよー";
                return;
            }
            window.location = `?user=${user}&to=${to}`;
        }
        function loadChat() {
            const user = paramsObj.user;
            const to = paramsObj.to;
            fetch(WEB_APP_URL + `?user=${user}&to=${to}`).then(res => res.json()).then(res => {
                if (res.status === "error") {
                    console.log("Error:" + res.error);
                    return;
                }
                const data = res.content;
                let htmlStr = "";
                data.forEach((item) => {
                    const which = item[2] === user;
                    if (which === true) htmlStr += `<div class="oppMessa"><div class="content">${item[1]}</div><div class="time">${item[0]}</div></div>`;
                    if (which === false) htmlStr += `<div class="myMessa"><div class="content">${item[1]}</div><div class="time">${item[0]}</div></div>`;
                })
                chatEle.innerHTML = htmlStr;
            })
        }
        if (ver === "chat") {
            window.setInterval(loadChat, 70000);
        }
    </script>
</body>

</html>