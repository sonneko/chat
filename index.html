<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã¡ã‚‡ã¨ã ã‘ãƒãƒ£ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        .title {
            font-size: 30px;
            width: 100vw;
            background-color: aqua;
            text-align: center;
            font-family: Arial, Helvetica, sans-serif;
            margin-bottom: 30px;
        }

        .attention {
            color: red;
            text-align: center;
            font-size: 20px;
        }

        .btn {
            margin: auto;
            margin-top: 40px;
            padding: 0 20px;
            color: #333333;
            background-color: #dddddd;
            font-size: 30px;
            border-radius: 3px;
            box-shadow: 2px 2px 6px 1px rgba(0, 0, 0, 0.45);
        }

        .btn:hover {
            box-shadow: inset 2px 2px 6px 1px rgba(0, 0, 0, 0);
        }

        #indexPage {
            text-align: center;
        }

        .chat {
            height: 90vh;
            padding: 100px;
            box-shadow: inset 2px 2px 6pz 1px rgba(0, 0, 0, 0.45);
        }

        #indexPage input {
            border-radius: 50px;
            width: 100vw;
            height: 100px;
            font-size: 30px;
            text-align: center;
        }

        #contentPage input {
            border-radius: 50px;
            width: 100vw;
            height: 50px;
            width: 100%;
            font-size: 20px;
            text-align: center;
            position: fixed;
            bottom: 0;
        }

        #indexPage .btn {}

        #indexPage p {
            margin-top: 60px;
            font-size: 20px;
        }

        .mess {
            padding: 0;
            padding: 0;
            margin-top: 100px;
            margin-bottom: 100px;
            border-radius: 50%;
        }

        .oppMessa .content {
            background-color: #dddddd;
            text-align: left;
        }

        .content {
            width: 50%;
            border-radius: 7px;
            font-size: 25px;
            padding: 0 20px;
        }

        .myMessa .content {
            text-align: right;
            background-color: aquamarine;
        }

        .time {
            color: rgba(0, 0, 0, 0.25);
        }

        .time {
            text-align: right;
        }

        .formBtn {
            text-align: right;
            font-size: 30px;
            position: fixed;
            bottom: 0;
            right: 0;
            z-index: 10;
        }

        #chat {
            margin-bottom: 200px;
        }
    </style>
</head>

<body>
    <div id="indexPage">
        <h1 class="title">ã¡ã‚‡ã¨ã ã‘ãƒãƒ£ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ </h1>
        <div class="attention">è‡ªåˆ†ã®IDã¨ç›¸æ‰‹ã®IDãŒæµå‡ºã™ã‚‹ã¨ã¡ã‚ƒã£ã¨å†…å®¹ãŒã°ã‚Œã¾ã™ã”æ³¨æ„ãã ã•ã„ã€‚</div>
        <a href="intro.html">ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦â†’</a>
        <a href="guide.html">ä½¿ã„æ–¹â†’</a>
        <a href="plate.html">æ²ç¤ºæ¿ä¸€è¦§</a>
        <a href="user.html">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a>
        <p>â†“è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚µãƒ¼IDã‚’å…¥åŠ›ï¼</p>
        <input type="text" id="userId">
        <p>â†“ç›¸æ‰‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›ï¼</p>
        <input type="text" id="toId">
        <div class="btn" onclick="btnClicked()">ã¡ã‚ƒã£ã¨ã‚’é–‹å§‹ï¼ï¼</div>
        <div id="formAttention"></div>
    </div>
    <div id="contentPage">
        <h1 class="title" onclick="loadChat()">ã¡ã‚‡ã¨ã ã‘ãƒãƒ£ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ </h1>
        <a href="index.html">â†æˆ»ã‚‹</a>
        <div id="chat"></div>
        <input type="text" id="formText">
        <div class="formBtn" onclick="submit()">ğŸ“¤</div>
    </div>
    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyqrKcM7nyESKmHp5Hodf99BwyihCogPugbQg8P09xBCAJnMM6c7kcCRhL5Fo3TfOrQ_A/exec";
        // è¦ç´ ã‚’å–å¾—
        const indexPageEle = document.getElementById("indexPage");
        const contentPageEle = document.getElementById("contentPage");
        const userIdEle = document.getElementById("userId");
        const toIdEle = document.getElementById("toId");
        const formAttentionEle = document.getElementById("formAttention");
        const chatEle = document.getElementById("chat");
        const formEle = document.getElementById("form");
        const formTextEle = document.getElementById("formText");
        //ç¾åœ¨ã®URLã‚’å–å¾—
        const nowUrl = window.location.href;
        // ver ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let ver;
        // paramsã‚’å–å¾—
        let paramsObj;
        try {
            const params = nowUrl.split("?")[1].split("&");
            paramsObj = {}
            params.forEach((item, index) => {
                const splitStr = item.split("=");
                paramsObj[splitStr[0]] = splitStr[1];
            })
        } catch {
            paramsObj = {
                user: null,
                to: null
            }
        }

        const render = (version) => {
            ver = version;
            console.log("render()" + ver);
            if (version === "chat") {
                indexPageEle.style.display = "none";
                contentPageEle.style.display = "initial";
                loadChat();
            }
            if (version === "index") {
                indexPageEle.style.display = "inlinebox";
                contentPageEle.style.display = "none";
            }
        }
        if (paramsObj.user === null) render("index");
        else if (paramsObj.to === null) render("index");
        else render("chat");
        function btnClicked() {
            user = userIdEle.value;
            to = toIdEle.value;
            if (user == "" || to == "") {
                formAttentionEle.innerText = "ãªã‚“ã‹æ›¸ã„ã¦ãªã„ã‚ˆãƒ¼";
                return;
            }
            window.location = `?user=${user}&to=${to}`;
        }
        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            const month = date.getMonth() + 1; // æœˆã¯0ã‹ã‚‰å§‹ã¾ã‚‹ã®ã§+1
            const day = date.getDate();
            const hours = date.getHours();
            const minutes = date.getMinutes();

            return `${month}æœˆ${day}æ—¥${hours}æ™‚${minutes}åˆ†`;
        }
        function loadChat() {
            console.log("load")
            const user = paramsObj.user;
            const to = paramsObj.to;
            fetch(WEB_APP_URL + `?user=${user}&to=${to}`).then(res => res.json()).then(res => {
                if (res.status === "error") {
                    console.log("Error:" + res.error);
                    return;
                }
                const data = res.content;
                let htmlStr = "";
                data.forEach((item) => {
                    const which = item[2] === user;
                    if (which === true) htmlStr += `<div class="myMessa"><div class="content">${item[1]}</div><div class="time">${item[0] + " by " + item[2]}</div></div>`;
                    if (which === false) htmlStr += `<div class="oppMessa"><div class="content">${item[1]}</div><div class="time">${item[0] + " by " + item[2]}</div></div>`;
                })
                chatEle.innerHTML = htmlStr;
            })
        }
        if (ver === "chat") {
            window.setInterval(loadChat, 50000);
        }
        function submit() {
            const user = paramsObj.user;
            const to = paramsObj.to;
            if (formTextEle.value === "") {
                alert("ãªã«ã‚‚ã‹ã„ã¦ãªã„ã‚ˆ");
                return;
            }
            const formData = {
                messa: [
                    formatDateTime(Date.now()),
                    formTextEle.value,
                    user,
                    to
                ]
            };
            console.log(formData);
            fetch(WEB_APP_URL, {
                method: "POST",
                body: JSON.stringify(formData)
            })
            formTextEle.value = "";
            loadChat();
        }
    </script>
</body>

</html>